// Purpose: Clean time column and ensure "HH:MM:SS" format
// Returns datetime (with 1900-01-01 base date) for Dataflows Gen2 compatibility
// Extracts time before "-" delimiter and validates time format

let
    fnCleanTime = (col as nullable text) as nullable datetime =>
        let
            // Handle null or empty inputs - return null immediately if input is null
            result = if col = null or col = "" then 
                null 
            else
                let
                    // Remove "1899" prefix if it exists (Excel date artifact)
                    remove1899 = if Text.StartsWith(col, "1899") then 
                        Text.Trim(Text.AfterDelimiter(col, "1899"))
                    else 
                        col,

                    // Remove anything within parentheses (including the parentheses)
                    removeParentheses = try Text.Replace(
                        Text.Replace(remove1899, 
                            Text.BetweenDelimiters(remove1899 & "()", "(", ")", 0, 0), 
                            ""
                        ),
                        "()", 
                        ""
                    ) otherwise remove1899,

                    // Extract text before the first "-" delimiter
                    timeBeforeDelimiter = try Text.BeforeDelimiter(removeParentheses, "-", 0) otherwise removeParentheses,

                    // Trim whitespace
                    trimTime = Text.Trim(timeBeforeDelimiter),

                    // Keep only digits and colons (removes any remaining non-time characters)
                    cleanTime = Text.Select(trimTime, {"0".."9", ":"}),
                
                    // Validate hours are 0-23
                    hoursPart = try Number.From(Text.BeforeDelimiter(cleanTime, ":")) otherwise null,
                    isValidTime = hoursPart <> null and hoursPart >= 0 and hoursPart <= 23,
                    
                    // Convert validated time string to datetime
                    convertToDateTime = if isValidTime then
                        try 
                            let
                                // Parse time components
                                timeParts = Text.Split(cleanTime, ":"),
                                hours = Number.From(timeParts{0}),
                                minutes = if List.Count(timeParts) > 1 then Number.From(timeParts{1}) else 0,
                                seconds = if List.Count(timeParts) > 2 then Number.From(timeParts{2}) else 0,
                                
                                // Create datetime with base date 1900-01-01
                                dateTimeValue = #datetime(1900, 1, 1, hours, minutes, seconds)
                            in
                                dateTimeValue
                        otherwise null
                    else 
                        null
                in
                    convertToDateTime
        in
            result
in
    fnCleanTime
