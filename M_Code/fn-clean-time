// Purpose: Clean time column and ensure "HH:MM:SS" format
// Extracts time before "-" delimiter and validates time format

let
    fnCleanTime = (col as nullable text) as nullable text =>
        let
            // Handle null or empty inputs - return null immediately if input is null
            result = if col = null or col = "" then 
                null 
            else
                let
                    // Remove "1899" prefix if it exists (Excel date artifact)
                    remove1899 = if Text.StartsWith(col, "1899") then 
                        Text.Trim(Text.AfterDelimiter(col, "1899"))
                    else 
                        col,

                    // Remove anything within parentheses (including the parentheses)
                    removeParentheses = try Text.Replace(
                        Text.Replace(remove1899, 
                            Text.BetweenDelimiters(col & "()", "(", ")", 0, 0), 
                            ""
                        ),
                        "()", 
                        ""
                    ) otherwise col,

                    // Extract text before the first "-" delimiter
                    timeBeforeDelimiter = try Text.BeforeDelimiter(removeParentheses, "-", 0) otherwise removeParentheses,

                    // Trim whitespace
                    trimTime = Text.Trim(timeBeforeDelimiter),

                    // Keep only digits and colons (removes any remaining non-time characters)
                    cleanTime = Text.Select(trimTime, {"0".."9", ":"}),
                
                    // Validate hours are 0-23
                    hoursPart = try Number.From(Text.BeforeDelimiter(cleanTime, ":")) otherwise null,
                    isValidTime = hoursPart <> null and hoursPart >= 0 and hoursPart <= 23,
                    
                    validatedTime = if isValidTime then cleanTime else null
                in
                    validatedTime
        in
            result
in
    fnCleanTime
